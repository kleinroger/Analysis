<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®å¯è§†åŒ–å¤§å± - æ™ºèƒ½åˆ†æå¹³å°</title>
    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <!-- ECharts GL for 3D -->
    <script src="https://cdn.jsdelivr.net/npm/echarts-gl@2.0.9/dist/echarts-gl.min.js"></script>
    <!-- China Map -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@4.9.0/map/js/china.js"></script>
    <!-- jQuery -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif;
            background: #0a0e27;
            color: #fff;
            overflow: hidden;
            min-height: 100vh;
        }
        
        /* ========== èƒŒæ™¯åŠ¨ç”» ========== */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: 
                radial-gradient(ellipse at 10% 20%, rgba(16, 185, 129, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 90% 80%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(139, 92, 246, 0.05) 0%, transparent 70%),
                linear-gradient(180deg, #0a0e27 0%, #111936 100%);
        }
        
        .bg-animation::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(2px 2px at 20px 30px, rgba(255,255,255,0.3), transparent),
                radial-gradient(2px 2px at 40px 70px, rgba(255,255,255,0.2), transparent),
                radial-gradient(1px 1px at 90px 40px, rgba(255,255,255,0.4), transparent),
                radial-gradient(2px 2px at 130px 80px, rgba(255,255,255,0.2), transparent),
                radial-gradient(1px 1px at 160px 120px, rgba(255,255,255,0.3), transparent);
            background-size: 200px 200px;
            animation: twinkle 5s ease-in-out infinite;
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        /* ========== ä¸»å®¹å™¨ ========== */
        .dashboard-container {
            width: 100vw;
            height: 100vh;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        /* ========== å¤´éƒ¨ ========== */
        .dashboard-header {
            height: 80px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(59, 130, 246, 0.3) 15%, 
                rgba(59, 130, 246, 0.5) 50%, 
                rgba(59, 130, 246, 0.3) 85%, 
                transparent 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .dashboard-header::before,
        .dashboard-header::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 30%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #3b82f6, transparent);
        }
        
        .dashboard-header::before { left: 2%; }
        .dashboard-header::after { right: 2%; }
        
        .header-title {
            font-size: 32px;
            font-weight: bold;
            letter-spacing: 8px;
            background: linear-gradient(180deg, #fff 0%, #93c5fd 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(59, 130, 246, 0.5);
        }
        
        .header-time {
            position: absolute;
            right: 30px;
            font-size: 18px;
            color: #93c5fd;
            font-family: 'Consolas', monospace;
        }
        
        .header-date {
            position: absolute;
            left: 30px;
            font-size: 16px;
            color: #93c5fd;
        }
        
        /* ========== ä¸»ä½“å†…å®¹ ========== */
        .dashboard-body {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1.5fr 1fr;
            gap: 15px;
            min-height: 0;
        }
        
        /* ========== é¢æ¿é€šç”¨æ ·å¼ ========== */
        .panel {
            background: linear-gradient(180deg, 
                rgba(30, 41, 82, 0.8) 0%, 
                rgba(20, 27, 55, 0.9) 100%);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #3b82f6, transparent);
        }
        
        .panel-header {
            height: 40px;
            padding: 0 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(59, 130, 246, 0.1);
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .panel-icon {
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        .panel-title {
            font-size: 14px;
            font-weight: 500;
            color: #93c5fd;
            letter-spacing: 2px;
        }
        
        .panel-body {
            flex: 1;
            padding: 10px;
            min-height: 0;
            position: relative;
        }
        
        /* ========== å·¦ä¾§é¢æ¿ ========== */
        .left-panels {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        /* ========== ä¸­é—´é¢æ¿ ========== */
        .center-panels {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .center-top {
            flex: 2;
        }
        
        .center-bottom {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        /* ========== å³ä¾§é¢æ¿ ========== */
        .right-panels {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        /* ========== å›¾è¡¨å®¹å™¨ ========== */
        .chart-container {
            width: 100%;
            height: 100%;
        }
        
        /* ========== æ•°æ®åˆ—è¡¨ ========== */
        .data-list {
            height: 100%;
            overflow: hidden;
        }
        
        .data-list-header {
            display: grid;
            grid-template-columns: 50px 1fr 100px;
            padding: 8px 10px;
            background: rgba(59, 130, 246, 0.15);
            border-radius: 4px;
            margin-bottom: 8px;
            font-size: 12px;
            color: #93c5fd;
        }
        
        .data-list-body {
            height: calc(100% - 40px);
            overflow: hidden;
        }
        
        .data-list-scroll {
            animation: scrollUp 20s linear infinite;
        }
        
        @keyframes scrollUp {
            0% { transform: translateY(0); }
            100% { transform: translateY(-50%); }
        }
        
        .data-list-item {
            display: grid;
            grid-template-columns: 50px 1fr 100px;
            padding: 10px;
            border-bottom: 1px solid rgba(59, 130, 246, 0.1);
            font-size: 13px;
            transition: background 0.3s;
        }
        
        .data-list-item:hover {
            background: rgba(59, 130, 246, 0.1);
        }
        
        .data-list-item .rank {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .data-list-item .rank.top1 { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .data-list-item .rank.top2 { background: linear-gradient(135deg, #94a3b8, #64748b); }
        .data-list-item .rank.top3 { background: linear-gradient(135deg, #cd7f32, #a0522d); }
        .data-list-item .rank.normal { background: rgba(59, 130, 246, 0.3); }
        
        .data-list-item .title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0 10px;
            color: #e2e8f0;
        }
        
        .data-list-item .time {
            color: #64748b;
            font-size: 12px;
        }
        
        /* ========== ç»Ÿè®¡å¡ç‰‡ ========== */
        .stat-cards {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            height: 100%;
        }
        
        .stat-card {
            background: linear-gradient(135deg, 
                rgba(59, 130, 246, 0.2) 0%, 
                rgba(139, 92, 246, 0.1) 100%);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.1) 0%, transparent 70%);
        }
        
        .stat-card .label {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 8px;
        }
        
        .stat-card .value {
            font-size: 28px;
            font-weight: bold;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .stat-card .trend {
            font-size: 12px;
            margin-top: 5px;
        }
        
        .stat-card .trend.up { color: #10b981; }
        .stat-card .trend.down { color: #ef4444; }
        
        /* ========== AI åˆ†æé¢æ¿ ========== */
        .ai-analysis {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .ai-input-wrap {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .ai-input {
            flex: 1;
            background: rgba(30, 41, 82, 0.8);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 6px;
            padding: 10px 15px;
            color: #fff;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }
        
        .ai-input:focus {
            border-color: #3b82f6;
        }
        
        .ai-input::placeholder {
            color: #64748b;
        }
        
        .ai-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            border: none;
            border-radius: 6px;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .ai-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }
        
        .ai-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .ai-result {
            flex: 1;
            background: rgba(20, 27, 55, 0.5);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 6px;
            padding: 15px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.8;
            color: #e2e8f0;
            white-space: pre-wrap; /* ä¿ç•™æ¢è¡Œå’Œç¼©è¿› */
        }
        
        .ai-result::-webkit-scrollbar {
            width: 6px;
        }
        
        .ai-result::-webkit-scrollbar-track {
            background: rgba(59, 130, 246, 0.1);
            border-radius: 3px;
        }
        
        .ai-result::-webkit-scrollbar-thumb {
            background: rgba(59, 130, 246, 0.3);
            border-radius: 3px;
        }
        
        .ai-typing {
            display: inline-block;
            width: 8px;
            height: 16px;
            background: #3b82f6;
            animation: blink 1s infinite;
            margin-left: 2px;
            vertical-align: middle;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* ========== 3D åœ°çƒå®¹å™¨ ========== */
        .globe-container {
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        .globe-stats {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-around;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 10px;
        }
        
        .globe-stat-item {
            text-align: center;
        }
        
        .globe-stat-item .label {
            font-size: 11px;
            color: #94a3b8;
        }
        
        .globe-stat-item .value {
            font-size: 18px;
            font-weight: bold;
            color: #3b82f6;
        }
        
        /* ========== åŠ è½½åŠ¨ç”» ========== */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #64748b;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(59, 130, 246, 0.2);
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ========== å“åº”å¼ ========== */
        @media screen and (max-width: 1600px) {
            .header-title { font-size: 28px; letter-spacing: 6px; }
            .stat-card .value { font-size: 24px; }
        }
        
        @media screen and (max-width: 1400px) {
            .dashboard-body {
                grid-template-columns: 1fr 1.2fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="bg-animation"></div>
    
    <div class="dashboard-container">
        <!-- å¤´éƒ¨ -->
        <header class="dashboard-header">
            <div class="header-date" id="headerDate">2025å¹´12æœˆ06æ—¥ æ˜ŸæœŸå…­</div>
            <h1 class="header-title">æ™ºèƒ½æ•°æ®å¯è§†åŒ–åˆ†æå¹³å°</h1>
            <div class="header-time" id="headerTime">21:00:00</div>
        </header>
        
        <!-- ä¸»ä½“ -->
        <main class="dashboard-body">
            <!-- å·¦ä¾§é¢æ¿ -->
            <div class="left-panels">
                <!-- æ•°æ®ç»Ÿè®¡ -->
                <div class="panel" style="flex: 0.8;">
                    <div class="panel-header">
                        <div class="panel-icon">ğŸ“Š</div>
                        <span class="panel-title">æ•°æ®æ¦‚è§ˆ</span>
                    </div>
                    <div class="panel-body">
                        <div class="stat-cards">
                            <div class="stat-card">
                                <div class="label">æ•°æ®æ€»é‡</div>
                                <div class="value" id="statTotal">0</div>
                                <div class="trend up">â†‘ 12.5%</div>
                            </div>
                            <div class="stat-card">
                                <div class="label">ä»Šæ—¥æ–°å¢</div>
                                <div class="value" id="statToday">0</div>
                                <div class="trend up">â†‘ 8.3%</div>
                            </div>
                            <div class="stat-card">
                                <div class="label">æ´»è·ƒæ¥æº</div>
                                <div class="value" id="statSources">0</div>
                                <div class="trend down">â†“ 2.1%</div>
                            </div>
                            <div class="stat-card">
                                <div class="label">åˆ†æä»»åŠ¡</div>
                                <div class="value" id="statTasks">0</div>
                                <div class="trend up">â†‘ 15.7%</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- é¥¼å›¾ -->
                <div class="panel" style="flex: 1;">
                    <div class="panel-header">
                        <div class="panel-icon">ğŸ¥§</div>
                        <span class="panel-title">æ•°æ®åˆ†ç±»å æ¯”</span>
                    </div>
                    <div class="panel-body">
                        <div id="pieChart" class="chart-container"></div>
                    </div>
                </div>
                
                <!-- æŸ±çŠ¶å›¾ -->
                <div class="panel" style="flex: 1;">
                    <div class="panel-header">
                        <div class="panel-icon">ğŸ“ˆ</div>
                        <span class="panel-title">è¿‘7æ—¥æ•°æ®è¶‹åŠ¿</span>
                    </div>
                    <div class="panel-body">
                        <div id="barChart" class="chart-container"></div>
                    </div>
                </div>
            </div>
            
            <!-- ä¸­é—´é¢æ¿ -->
            <div class="center-panels">
                <!-- åœ°å›¾ -->
                <div class="panel center-top">
                    <div class="panel-header">
                        <div class="panel-icon">ğŸ—ºï¸</div>
                        <span class="panel-title">å…¨å›½æ•°æ®çƒ­åŠ›åˆ†å¸ƒ</span>
                    </div>
                    <div class="panel-body">
                        <div id="mapChart" class="chart-container"></div>
                    </div>
                </div>
                
                <!-- åº•éƒ¨ä¸¤ä¸ªå›¾è¡¨ -->
                <div class="center-bottom">
                    <div class="panel">
                        <div class="panel-header">
                            <div class="panel-icon">ğŸ“‰</div>
                            <span class="panel-title">å®æ—¶æ•°æ®æµ</span>
                        </div>
                        <div class="panel-body">
                            <div id="lineChart" class="chart-container"></div>
                        </div>
                    </div>
                    <div class="panel">
                        <div class="panel-header">
                            <div class="panel-icon">ğŸ¯</div>
                            <span class="panel-title">å…³é”®æŒ‡æ ‡é›·è¾¾</span>
                        </div>
                        <div class="panel-body">
                            <div id="radarChart" class="chart-container"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å³ä¾§é¢æ¿ -->
            <div class="right-panels">
                <!-- 3D åœ°çƒ -->
                <div class="panel" style="flex: 1.2;">
                    <div class="panel-header">
                        <div class="panel-icon">ğŸŒ</div>
                        <span class="panel-title">å…¨çƒæ•°æ®åˆ†å¸ƒ</span>
                    </div>
                    <div class="panel-body">
                        <div class="globe-container">
                            <div id="globeChart" class="chart-container"></div>
                            <div class="globe-stats">
                                <div class="globe-stat-item">
                                    <div class="label">è¦†ç›–å›½å®¶</div>
                                    <div class="value">32</div>
                                </div>
                                <div class="globe-stat-item">
                                    <div class="label">æ•°æ®èŠ‚ç‚¹</div>
                                    <div class="value">156</div>
                                </div>
                                <div class="globe-stat-item">
                                    <div class="label">å®æ—¶è¿æ¥</div>
                                    <div class="value">89</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- æ•°æ®åˆ—è¡¨ -->
                <div class="panel" style="flex: 0.8;">
                    <div class="panel-header">
                        <div class="panel-icon">ğŸ“‹</div>
                        <span class="panel-title">æœ€æ–°æ•°æ®åŠ¨æ€</span>
                    </div>
                    <div class="panel-body">
                        <div class="data-list">
                            <div class="data-list-header">
                                <span>æ’å</span>
                                <span>æ ‡é¢˜</span>
                                <span>æ—¶é—´</span>
                            </div>
                            <div class="data-list-body">
                                <div class="data-list-scroll" id="dataListScroll">
                                    <!-- åŠ¨æ€å¡«å…… -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- AI åˆ†æ -->
                <div class="panel" style="flex: 1;">
                    <div class="panel-header">
                        <div class="panel-icon">ğŸ¤–</div>
                        <span class="panel-title">AI æ™ºèƒ½åˆ†æ</span>
                    </div>
                    <div class="panel-body">
                        <div class="ai-analysis">
                            <div class="ai-input-wrap">
                                <input type="text" class="ai-input" id="aiInput" placeholder="è¾“å…¥åˆ†æé—®é¢˜ï¼Œå¦‚ï¼šåˆ†ææœ€è¿‘æ•°æ®è¶‹åŠ¿...">
                                <button class="ai-btn" id="aiBtn" onclick="startAIAnalysis()">åˆ†æ</button>
                                <button class="ai-btn" id="aiSaveBtn" onclick="saveAnalysisReport()" style="display:none; margin-left:10px; background-color: #10b981;">ä¿å­˜</button>
                            </div>
                            <div class="ai-result" id="aiResult">
                                <div style="color: #64748b; text-align: center; padding-top: 20px;">
                                    ğŸ’¡ è¾“å…¥é—®é¢˜å¼€å§‹ AI æ™ºèƒ½åˆ†æ<br>
                                    <small>æ”¯æŒæ•°æ®è¶‹åŠ¿åˆ†æã€å¼‚å¸¸æ£€æµ‹ã€é¢„æµ‹å»ºè®®ç­‰</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <script>
        // ========== å…¨å±€å˜é‡ ==========
        let mapChart, pieChart, barChart, lineChart, radarChart, globeChart;
        let latestData = [];
        
        // ========== åˆå§‹åŒ– ==========
        $(document).ready(function() {
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            initCharts();
            loadData();
            
            // å®šæ—¶åˆ·æ–°æ•°æ®
            setInterval(loadData, 60000);
            
            // çª—å£å¤§å°å˜åŒ–æ—¶é‡ç»˜å›¾è¡¨
            $(window).resize(function() {
                mapChart && mapChart.resize();
                pieChart && pieChart.resize();
                barChart && barChart.resize();
                lineChart && lineChart.resize();
                radarChart && radarChart.resize();
                globeChart && globeChart.resize();
            });
            
            // AI è¾“å…¥æ¡†å›è½¦äº‹ä»¶
            $('#aiInput').keypress(function(e) {
                if (e.which === 13) {
                    startAIAnalysis();
                }
            });
        });
        
        // ========== æ›´æ–°æ—¶é—´ ==========
        function updateDateTime() {
            const now = new Date();
            const days = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
            
            $('#headerDate').text(
                now.getFullYear() + 'å¹´' + 
                (now.getMonth() + 1).toString().padStart(2, '0') + 'æœˆ' + 
                now.getDate().toString().padStart(2, '0') + 'æ—¥ ' + 
                days[now.getDay()]
            );
            
            $('#headerTime').text(
                now.getHours().toString().padStart(2, '0') + ':' +
                now.getMinutes().toString().padStart(2, '0') + ':' +
                now.getSeconds().toString().padStart(2, '0')
            );
        }
        
        // ========== åˆå§‹åŒ–å›¾è¡¨ ==========
        function initCharts() {
            // ä¸­å›½åœ°å›¾
            mapChart = echarts.init(document.getElementById('mapChart'));
            initMapChart();
            
            // é¥¼å›¾
            pieChart = echarts.init(document.getElementById('pieChart'));
            initPieChart();
            
            // æŸ±çŠ¶å›¾
            barChart = echarts.init(document.getElementById('barChart'));
            initBarChart();
            
            // æŠ˜çº¿å›¾
            lineChart = echarts.init(document.getElementById('lineChart'));
            initLineChart();
            
            // é›·è¾¾å›¾
            radarChart = echarts.init(document.getElementById('radarChart'));
            initRadarChart();
            
            // 3D åœ°çƒ
            globeChart = echarts.init(document.getElementById('globeChart'));
            initGlobeChart();
        }
        
        // ========== ä¸­å›½åœ°å›¾ ==========
        function initMapChart() {
            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'item',
                    backgroundColor: 'rgba(20, 27, 55, 0.9)',
                    borderColor: '#3b82f6',
                    textStyle: { color: '#fff' },
                    formatter: function(params) {
                        if (params.data) {
                            let keywords = params.data.keywords ? params.data.keywords.join(', ') : '';
                            return `<strong>${params.name}</strong><br/>æ•°æ®é‡: ${params.value || 0}<br/>çƒ­è¯: ${keywords}`;
                        }
                        return params.name;
                    }
                },
                visualMap: {
                    min: 0,
                    max: 100,
                    left: 'left',
                    top: 'bottom',
                    text: ['é«˜', 'ä½'],
                    textStyle: { color: '#94a3b8' },
                    inRange: {
                        color: ['#1e3a5f', '#2563eb', '#3b82f6', '#60a5fa', '#93c5fd']
                    },
                    calculable: true
                },
                geo: {
                    map: 'china',
                    roam: true,
                    zoom: 1.2,
                    label: {
                        show: false
                    },
                    itemStyle: {
                        areaColor: '#1e3a5f',
                        borderColor: '#3b82f6',
                        borderWidth: 1
                    },
                    emphasis: {
                        itemStyle: {
                            areaColor: '#2563eb',
                            shadowBlur: 20,
                            shadowColor: 'rgba(59, 130, 246, 0.5)'
                        },
                        label: {
                            show: true,
                            color: '#fff'
                        }
                    }
                },
                series: [{
                    name: 'æ•°æ®åˆ†å¸ƒ',
                    type: 'map',
                    map: 'china',
                    geoIndex: 0,
                    data: []
                }, {
                    name: 'çƒ­ç‚¹',
                    type: 'effectScatter',
                    coordinateSystem: 'geo',
                    data: [],
                    symbolSize: function(val) {
                        return Math.max(val[2] / 5, 8);
                    },
                    rippleEffect: {
                        brushType: 'stroke',
                        scale: 4
                    },
                    itemStyle: {
                        color: '#f59e0b',
                        shadowBlur: 10,
                        shadowColor: '#f59e0b'
                    }
                }]
            };
            mapChart.setOption(option);
        }
        
        // ========== é¥¼å›¾ ==========
        function initPieChart() {
            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'item',
                    backgroundColor: 'rgba(20, 27, 55, 0.9)',
                    borderColor: '#3b82f6',
                    textStyle: { color: '#fff' }
                },
                legend: {
                    orient: 'vertical',
                    right: 10,
                    top: 'center',
                    textStyle: { color: '#94a3b8', fontSize: 11 }
                },
                series: [{
                    name: 'æ•°æ®åˆ†ç±»',
                    type: 'pie',
                    radius: ['40%', '70%'],
                    center: ['40%', '50%'],
                    avoidLabelOverlap: false,
                    itemStyle: {
                        borderRadius: 8,
                        borderColor: '#0a0e27',
                        borderWidth: 2
                    },
                    label: {
                        show: false
                    },
                    emphasis: {
                        label: {
                            show: true,
                            fontSize: 14,
                            fontWeight: 'bold',
                            color: '#fff'
                        },
                        itemStyle: {
                            shadowBlur: 20,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    },
                    data: [
                        { value: 35, name: 'ç§‘æŠ€èµ„è®¯', itemStyle: { color: '#3b82f6' } },
                        { value: 25, name: 'è´¢ç»æ–°é—»', itemStyle: { color: '#8b5cf6' } },
                        { value: 20, name: 'ç¤¾ä¼šæ°‘ç”Ÿ', itemStyle: { color: '#10b981' } },
                        { value: 12, name: 'ä½“è‚²å¨±ä¹', itemStyle: { color: '#f59e0b' } },
                        { value: 8, name: 'å…¶ä»–', itemStyle: { color: '#64748b' } }
                    ]
                }]
            };
            pieChart.setOption(option);
        }
        
        // ========== æŸ±çŠ¶å›¾ ==========
        function initBarChart() {
            const days = [];
            const values = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                days.push((d.getMonth() + 1) + '/' + d.getDate());
                values.push(Math.floor(Math.random() * 100) + 50);
            }
            
            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(20, 27, 55, 0.9)',
                    borderColor: '#3b82f6',
                    textStyle: { color: '#fff' }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    top: '10%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: days,
                    axisLine: { lineStyle: { color: '#3b82f6' } },
                    axisLabel: { color: '#94a3b8', fontSize: 10 }
                },
                yAxis: {
                    type: 'value',
                    axisLine: { show: false },
                    splitLine: { lineStyle: { color: 'rgba(59, 130, 246, 0.1)' } },
                    axisLabel: { color: '#94a3b8', fontSize: 10 }
                },
                series: [{
                    data: values,
                    type: 'bar',
                    barWidth: '50%',
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: '#3b82f6' },
                            { offset: 1, color: '#1e3a5f' }
                        ]),
                        borderRadius: [4, 4, 0, 0]
                    },
                    emphasis: {
                        itemStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: '#60a5fa' },
                                { offset: 1, color: '#3b82f6' }
                            ])
                        }
                    }
                }]
            };
            barChart.setOption(option);
        }
        
        // ========== æŠ˜çº¿å›¾ ==========
        function initLineChart() {
            const times = [];
            const values = [];
            for (let i = 0; i < 20; i++) {
                times.push(i + ':00');
                values.push(Math.floor(Math.random() * 50) + 20);
            }
            
            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(20, 27, 55, 0.9)',
                    borderColor: '#3b82f6',
                    textStyle: { color: '#fff' }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    top: '10%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: times,
                    axisLine: { lineStyle: { color: '#3b82f6' } },
                    axisLabel: { color: '#94a3b8', fontSize: 9, interval: 3 }
                },
                yAxis: {
                    type: 'value',
                    axisLine: { show: false },
                    splitLine: { lineStyle: { color: 'rgba(59, 130, 246, 0.1)' } },
                    axisLabel: { color: '#94a3b8', fontSize: 10 }
                },
                series: [{
                    data: values,
                    type: 'line',
                    smooth: true,
                    symbol: 'none',
                    lineStyle: {
                        color: '#3b82f6',
                        width: 2
                    },
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(59, 130, 246, 0.4)' },
                            { offset: 1, color: 'rgba(59, 130, 246, 0)' }
                        ])
                    }
                }]
            };
            lineChart.setOption(option);
            
            // å®æ—¶æ›´æ–°
            setInterval(function() {
                values.shift();
                values.push(Math.floor(Math.random() * 50) + 20);
                lineChart.setOption({
                    series: [{ data: values }]
                });
            }, 2000);
        }
        
        // ========== é›·è¾¾å›¾ ==========
        function initRadarChart() {
            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    backgroundColor: 'rgba(20, 27, 55, 0.9)',
                    borderColor: '#3b82f6',
                    textStyle: { color: '#fff' }
                },
                radar: {
                    indicator: [
                        { name: 'æ•°æ®è´¨é‡', max: 100 },
                        { name: 'æ›´æ–°é¢‘ç‡', max: 100 },
                        { name: 'è¦†ç›–èŒƒå›´', max: 100 },
                        { name: 'å‡†ç¡®æ€§', max: 100 },
                        { name: 'æ—¶æ•ˆæ€§', max: 100 }
                    ],
                    shape: 'polygon',
                    splitNumber: 4,
                    axisName: {
                        color: '#94a3b8',
                        fontSize: 11
                    },
                    splitLine: {
                        lineStyle: { color: 'rgba(59, 130, 246, 0.2)' }
                    },
                    splitArea: {
                        areaStyle: { color: ['rgba(59, 130, 246, 0.05)', 'rgba(59, 130, 246, 0.1)'] }
                    },
                    axisLine: {
                        lineStyle: { color: 'rgba(59, 130, 246, 0.3)' }
                    }
                },
                series: [{
                    type: 'radar',
                    data: [{
                        value: [85, 78, 92, 88, 75],
                        name: 'å½“å‰æŒ‡æ ‡',
                        areaStyle: {
                            color: 'rgba(59, 130, 246, 0.3)'
                        },
                        lineStyle: {
                            color: '#3b82f6',
                            width: 2
                        },
                        itemStyle: {
                            color: '#3b82f6'
                        }
                    }]
                }]
            };
            radarChart.setOption(option);
        }
        
        // ========== 3D åœ°çƒ ==========
        function initGlobeChart() {
            const ROOT_PATH = 'https://cdn.jsdelivr.net/gh/apache/echarts-examples@gh-pages';
            
            // åŠ è½½ä¸–ç•Œåœ°å›¾æ•°æ®ç”¨äºç»˜åˆ¶è¾¹ç•Œçº¿
            $.getJSON('https://cdn.jsdelivr.net/npm/echarts@4.9.0/map/json/world.json', function(worldJson) {
                // æå–è¾¹ç•Œçº¿æ•°æ®
                var linesData = [];
                worldJson.features.forEach(function(feature) {
                    if (feature.geometry.type === 'Polygon') {
                        feature.geometry.coordinates.forEach(function(ring) {
                            linesData.push({ coords: ring });
                        });
                    } else if (feature.geometry.type === 'MultiPolygon') {
                        feature.geometry.coordinates.forEach(function(polygon) {
                            polygon.forEach(function(ring) {
                                linesData.push({ coords: ring });
                            });
                        });
                    }
                });

                const option = {
                    backgroundColor: 'transparent',
                    globe: {
                        baseTexture: ROOT_PATH + '/data-gl/asset/world.topo.bathy.200401.jpg',
                        heightTexture: ROOT_PATH + '/data-gl/asset/world.topo.bathy.200401.jpg',
                        displacementScale: 0.1, // ç¨å¾®è°ƒå°ä¸€ç‚¹ä½ç§»ï¼Œè®©çº¿æ¡è´´åˆæ›´ç´§å¯†
                        displacementQuality: 'high',
                        shading: 'realistic',
                        environment: ROOT_PATH + '/data-gl/asset/starfield.jpg',
                        
                        atmosphere: {
                            show: true,
                            offset: 5,
                            color: '#3b82f6',
                            glowPower: 1.5,
                            innerGlowPower: 0.5
                        },
                        
                        realisticMaterial: {
                            roughness: 0.6
                        },
                        
                        postEffect: {
                            enable: true,
                            SSAO: {
                                enable: true,
                                radius: 2,
                                intensity: 1.2
                            }
                        },
                        
                        light: {
                            main: {
                                intensity: 3, // ä¸»å…‰æºç¨å¾®è°ƒä½ï¼Œé¿å…è¿‡åº¦æ›å…‰
                                shadow: true
                            },
                            ambient: {
                                intensity: 0.8 // ç¯å¢ƒå…‰è°ƒé«˜ï¼Œè®©çº¹ç†æ›´æ¸…æ™°
                            },
                            ambientCubemap: {
                                texture: ROOT_PATH + '/data-gl/asset/pisa.hdr',
                                diffuseIntensity: 1.0
                            }
                        },
                        
                        viewControl: {
                            autoRotate: true,
                            autoRotateSpeed: 3,
                            distance: 150, // æ‹‰è¿‘è·ç¦»
                            targetCoord: [105, 35] // èšç„¦ä¸­å›½
                        }
                    },
                    series: [{
                        type: 'lines3D',
                        coordinateSystem: 'globe',
                        effect: {
                            show: false
                        },
                        blendMode: 'lighter',
                        lineStyle: {
                            color: '#ffd700', // é‡‘è‰²è¾¹ç•Œ
                            width: 1,
                            opacity: 0.6
                        },
                        data: linesData,
                        silent: true // ä¸å“åº”é¼ æ ‡äº‹ä»¶
                    }]
                };
                globeChart.setOption(option);
            });
        }
        
        // ========== åŠ è½½æ•°æ® ==========
        function loadData() {
            loadStats();
            loadPieData();
            
            // åŠ è½½æœ€æ–°æ•°æ®
            $.getJSON('/dashboard/api/latest', function(data) {
                latestData = data;
                updateDataList(data);
            });
            
            // åŠ è½½çƒ­åŠ›å›¾æ•°æ®
            $.getJSON('/dashboard/api/heatmap', function(data) {
                updateMapData(data);
            });
        }
        
        // åŠ è½½ç»Ÿè®¡æ•°æ®
        function loadStats() {
            $.getJSON('/dashboard/api/stats', function(data) {
                animateNumber('statTotal', data.total);
                animateNumber('statToday', data.today);
                animateNumber('statSources', data.sources);
                animateNumber('statTasks', data.tasks);
            });
        }

        // åŠ è½½é¥¼å›¾æ•°æ®
        function loadPieData() {
            $.getJSON('/dashboard/api/category-stats', function(data) {
                if (pieChart && data && data.length > 0) {
                    pieChart.setOption({
                        series: [{
                            data: data
                        }]
                    });
                }
            });
        }
        
        // ========== æ›´æ–°æ•°æ®åˆ—è¡¨ ==========
        function updateDataList(data) {
            let html = '';
            data.forEach(function(item, index) {
                const rankClass = index < 3 ? 'top' + (index + 1) : 'normal';
                const time = item.created_at ? item.created_at.split(' ')[1].substring(0, 5) : '--:--';
                html += `
                    <div class="data-list-item">
                        <span class="rank ${rankClass}">${index + 1}</span>
                        <span class="title" title="${item.title}">${item.title}</span>
                        <span class="time">${time}</span>
                    </div>
                `;
            });
            // å¤åˆ¶ä¸€ä»½ç”¨äºæ— ç¼æ»šåŠ¨
            html += html;
            $('#dataListScroll').html(html);
        }
        
        // ========== æ•°å­—åŠ¨ç”» ==========
        function animateNumber(id, target) {
            const el = document.getElementById(id);
            const start = parseInt(el.textContent) || 0;
            const duration = 1000;
            const startTime = performance.now();
            
            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const current = Math.floor(start + (target - start) * progress);
                el.textContent = current.toLocaleString();
                
                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }
            
            requestAnimationFrame(update);
        }
        
        // ========== æ›´æ–°åœ°å›¾æ•°æ® ==========
        function updateMapData(data) {
            if (!data || data.length === 0) return;
            
            // çœä»½åæ ‡æ˜ å°„
            const geoCoord = {
                'åŒ—äº¬': [116.46, 39.92], 'å¤©æ´¥': [117.2, 39.13], 'æ²³åŒ—': [114.48, 38.03],
                'å±±è¥¿': [112.55, 37.87], 'å†…è’™å¤': [111.65, 40.82], 'è¾½å®': [123.43, 41.8],
                'å‰æ—': [125.32, 43.9], 'é»‘é¾™æ±Ÿ': [126.53, 45.8], 'ä¸Šæµ·': [121.48, 31.22],
                'æ±Ÿè‹': [118.78, 32.04], 'æµ™æ±Ÿ': [120.15, 30.28], 'å®‰å¾½': [117.28, 31.86],
                'ç¦å»º': [119.3, 26.08], 'æ±Ÿè¥¿': [115.89, 28.68], 'å±±ä¸œ': [117.0, 36.67],
                'æ²³å—': [113.65, 34.76], 'æ¹–åŒ—': [114.31, 30.52], 'æ¹–å—': [112.98, 28.19],
                'å¹¿ä¸œ': [113.26, 23.13], 'å¹¿è¥¿': [108.33, 22.84], 'æµ·å—': [110.35, 20.02],
                'é‡åº†': [106.55, 29.57], 'å››å·': [104.07, 30.67], 'è´µå·': [106.71, 26.57],
                'äº‘å—': [102.71, 25.05], 'è¥¿è—': [91.13, 29.66], 'é™•è¥¿': [108.95, 34.27],
                'ç”˜è‚ƒ': [103.82, 36.07], 'é’æµ·': [101.78, 36.62], 'å®å¤': [106.27, 38.47],
                'æ–°ç–†': [87.62, 43.79], 'å°æ¹¾': [121.5, 25.05], 'é¦™æ¸¯': [114.17, 22.32],
                'æ¾³é—¨': [113.55, 22.2]
            };
            
            // æ›´æ–°åœ°å›¾æ•°æ®
            const mapData = data.map(item => ({
                name: item.name,
                value: item.value,
                keywords: item.keywords || []
            }));
            
            // æ›´æ–°æ•£ç‚¹æ•°æ®
            const scatterData = data.filter(item => geoCoord[item.name]).map(item => ({
                name: item.name,
                value: [...geoCoord[item.name], item.value]
            }));
            
            mapChart.setOption({
                series: [
                    { data: mapData },
                    { data: scatterData }
                ]
            });
        }
        
        // ========== AI åˆ†æ ==========
        function startAIAnalysis() {
            const question = $('#aiInput').val().trim();
            if (!question) {
                alert('è¯·è¾“å…¥åˆ†æé—®é¢˜');
                return;
            }
            
            const $btn = $('#aiBtn');
            const $result = $('#aiResult');
            
            $btn.prop('disabled', true).text('åˆ†æä¸­...');
            $result.html('<div class="loading"><div class="loading-spinner"></div></div>');
            
            // å‡†å¤‡æ•°æ®æ‘˜è¦
            const dataSummary = latestData.slice(0, 10).map((item, i) => 
                `${i + 1}. ${item.title}`
            ).join('\n');
            
            $.ajax({
                url: '/dashboard/api/ai-analysis',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    question: question,
                    data_summary: dataSummary
                }),
                success: function(response) {
                    if (response.success) {
                        // æ‰“å­—æœºæ•ˆæœæ˜¾ç¤ºç»“æœ
                        typeWriter($result, response.analysis);
                        
                        // æ˜¾ç¤ºä¿å­˜æŒ‰é’®å¹¶å­˜å‚¨å†…å®¹
                        window.currentAnalysisContent = response.analysis;
                        $('#aiSaveBtn').show();
                    } else {
                        $result.html('<div style="color: #ef4444;">åˆ†æå¤±è´¥: ' + (response.error || 'æœªçŸ¥é”™è¯¯') + '</div>');
                        $('#aiSaveBtn').hide();
                    }
                },
                error: function(xhr) {
                    $result.html('<div style="color: #ef4444;">è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>');
                    $('#aiSaveBtn').hide();
                },
                complete: function() {
                    $btn.prop('disabled', false).text('åˆ†æ');
                }
            });
        }
        
        // ä¿å­˜åˆ†ææŠ¥å‘Š
        function saveAnalysisReport() {
            if (!window.currentAnalysisContent) return;
            
            const title = prompt("è¯·è¾“å…¥æŠ¥å‘Šæ ‡é¢˜", "æ•°æ®å¤§å±æ™ºèƒ½åˆ†ææŠ¥å‘Š_" + new Date().toISOString().slice(0,10));
            if (title) {
                $.ajax({
                    url: '/reports/api/save',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        title: title,
                        content: window.currentAnalysisContent,
                        report_type: 'dashboard_ai'
                    }),
                    success: function(res) {
                        if (res.success) {
                            alert('æŠ¥å‘Šä¿å­˜æˆåŠŸï¼');
                            $('#aiSaveBtn').hide();
                        } else {
                            alert('ä¿å­˜å¤±è´¥: ' + (res.error || 'æœªçŸ¥é”™è¯¯'));
                        }
                    },
                    error: function() {
                        alert('ä¿å­˜è¯·æ±‚å¤±è´¥');
                    }
                });
            }
        }
        
        // ========== æ‰“å­—æœºæ•ˆæœ ==========
        function typeWriter($el, text) {
            $el.html('');
            let index = 0;
            const speed = 20;
            
            function type() {
                if (index < text.length) {
                    $el.append(text.charAt(index));
                    index++;
                    setTimeout(type, speed);
                }
            }
            
            type();
        }
    </script>
</body>
</html>
