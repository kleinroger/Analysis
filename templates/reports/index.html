{% extends "base.html" %}

{% block content %}
<div class="layui-card">
    <div class="layui-card-header">分析报告管理</div>
    <div class="layui-card-body">
        <div class="layui-form layui-row layui-col-space15">
            <div class="layui-col-md4">
                <div class="layui-input-wrap">
                    <input type="text" id="keyword" placeholder="搜索报告标题" class="layui-input">
                    <div class="layui-input-suffix">
                        <i class="layui-icon layui-icon-search"></i>
                    </div>
                </div>
            </div>
            <div class="layui-col-md2">
                <button class="layui-btn" id="btnSearch">搜索</button>
            </div>
        </div>

        <table class="layui-table" id="reportTable" lay-filter="reportTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>标题</th>
                    <th>类型</th>
                    <th>创建时间</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <!-- Dynamic Content -->
            </tbody>
        </table>
    </div>
</div>

<!-- 报告详情弹窗模板 -->
<div id="reportDetail" style="display: none; padding: 20px;">
    <h2 id="detailTitle" style="text-align: center; margin-bottom: 20px;"></h2>
    <div id="detailMeta" style="text-align: center; color: #999; margin-bottom: 20px;"></div>
    <div id="detailContent" style="line-height: 1.8; font-size: 16px; white-space: pre-wrap; text-align: left;"></div>
</div>

<!-- 引入 html2pdf -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

{% endblock %}

{% block scripts %}
<script>
layui.use(['layer', 'form', 'table'], function(){
    var layer = layui.layer,
        $ = layui.$;

    function loadReports(keyword) {
        $.get('{{ url_for("reports.list_reports") }}', { keyword: keyword }, function(res) {
            var html = '';
            res.forEach(function(item) {
                html += `<tr>
                    <td>${item.id}</td>
                    <td>${item.title}</td>
                    <td>${item.report_type}</td>
                    <td>${item.created_at}</td>
                    <td>
                        <button class="layui-btn layui-btn-sm layui-btn-normal btn-view" data-id="${item.id}">查看</button>
                        <button class="layui-btn layui-btn-sm btn-pdf" data-id="${item.id}">PDF下载</button>
                        <button class="layui-btn layui-btn-sm layui-btn-danger btn-del" data-id="${item.id}">删除</button>
                    </td>
                </tr>`;
            });
            $('#tableBody').html(html);
            if(res.length === 0) {
                $('#tableBody').html('<tr><td colspan="5" style="text-align:center;">暂无数据</td></tr>');
            }
        });
    }

    loadReports();

    $('#btnSearch').click(function() {
        loadReports($('#keyword').val());
    });

    // 查看
    $(document).on('click', '.btn-view', function() {
        var id = $(this).data('id');
        $.get('/reports/api/detail/' + id, function(res) {
            $('#detailTitle').text(res.title);
            $('#detailMeta').text('生成时间: ' + res.created_at + ' | 类型: ' + res.report_type);
            $('#detailContent').text(res.content);
            
            layer.open({
                type: 1,
                title: '报告详情',
                area: ['800px', '600px'],
                content: $('#reportDetail'),
                btn: ['下载PDF', '关闭'],
                yes: function(index, layero) {
                    generatePDF(res);
                    return false; // prevent close
                },
                btn2: function(index, layero) {
                    layer.close(index);
                }
            });
        });
    });

    // PDF 下载
    $(document).on('click', '.btn-pdf', function() {
        var id = $(this).data('id');
        $.get('/reports/api/detail/' + id, function(res) {
            generatePDF(res);
        });
    });

    // 删除
    $(document).on('click', '.btn-del', function() {
        var id = $(this).data('id');
        layer.confirm('确定要删除该报告吗？', function(index){
            $.ajax({
                url: '/reports/api/delete/' + id,
                type: 'DELETE',
                success: function(res) {
                    if(res.success) {
                        layer.msg('删除成功');
                        loadReports($('#keyword').val());
                    }
                }
            });
            layer.close(index);
        });
    });

    function generatePDF(report) {
        var element = document.createElement('div');
        element.style.padding = '20px';
        element.innerHTML = `
            <h1 style="text-align: center; margin-bottom: 20px;">${report.title}</h1>
            <div style="text-align: center; color: #666; margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                生成时间: ${report.created_at} <br>
                来源: 舆情分析系统
            </div>
            <div style="font-size: 14px; line-height: 1.8; white-space: pre-wrap; font-family: 'SimSun', serif;">
                ${report.content}
            </div>
        `;
        
        var opt = {
            margin:       10,
            filename:     report.title + '.pdf',
            image:        { type: 'jpeg', quality: 0.95 },
            html2canvas:  { scale: 1.5 },
            jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        
        var loadIndex = layer.msg('正在生成PDF,请稍候...', {icon: 16, shade: 0.1, time: 0}); // Show loading message
        
        html2pdf().set(opt).from(element).save().then(function(){
            layer.close(loadIndex);
            layer.msg('已成功下载', {icon: 1, time: 2000});
        }).catch(function(err){
            layer.close(loadIndex);
            layer.msg('下载失败，请重试', {icon: 2});
            console.error(err);
        });
    }
});
</script>
{% endblock %}
