{% extends 'base.html' %}
{% block content %}
<div class="layui-card">
  <div class="layui-card-header">AI引擎管理</div>
  <div class="layui-card-body">
    <div class="layui-form" style="margin-bottom:10px">
      <div class="layui-form-item">
        <div class="layui-inline">
          <label class="layui-form-label">搜索</label>
          <div class="layui-input-inline" style="width:300px">
            <input type="text" id="q" placeholder="按服务商或模型搜索" autocomplete="off" class="layui-input">
          </div>
        </div>
        <div class="layui-inline">
          <button class="layui-btn" id="btn-search"><i class="layui-icon layui-icon-search"></i> 查询</button>
          <button class="layui-btn layui-btn-primary" id="btn-refresh"><i class="layui-icon layui-icon-refresh"></i> 刷新</button>
          <button class="layui-btn layui-btn-normal" id="btn-add"><i class="layui-icon layui-icon-add-1"></i> 新增引擎</button>
        </div>
      </div>
    </div>

    <div id="grid" class="engine-grid"></div>
    <div id="pager" style="text-align:center;margin-top:10px"></div>
  </div>
 </div>
{% endblock %}
{% block page_script %}
<style>
.engine-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
@media (max-width: 1280px){.engine-grid{grid-template-columns:repeat(3,1fr)}}
@media (max-width: 992px){.engine-grid{grid-template-columns:repeat(2,1fr)}}
@media (max-width: 640px){.engine-grid{grid-template-columns:repeat(1,1fr)}}
.engine-card{border-radius:12px;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,.08);background:#fff}
.engine-card-header{padding:16px;color:#fff;background:linear-gradient(135deg,#4b7bf0,#5a62f2)}
.engine-card-body{padding:14px}
.kv{display:flex;align-items:center;margin-bottom:8px}
.kv .k{width:92px;color:#666}
.kv .v{flex:1;min-width:0}
.text-ellipsis{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ops{display:flex;align-items:center;gap:8px;margin-top:10px}
</style>
<script>
layui.use(['jquery','layer','laypage'], function(){
  var $ = layui.jquery; var layer = layui.layer; var laypage = layui.laypage;
  var cache = []; var total = 0; var page = 1; var limit = 12; var q = '';
  function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function maskKey(k){ k=String(k||''); if(k.length<=8) return '****'; return k.slice(0,4)+'****'+k.slice(-4); }
  function render(){
    var html = '';
    cache.forEach(function(it){
      html += '<div class="engine-card">'+
                '<div class="engine-card-header">'+
                  '<div style="font-size:18px;font-weight:600" class="text-ellipsis">'+esc(it.provider)+' · '+esc(it.model_name)+'</div>'+
                  '<div style="font-size:12px;opacity:.9" class="text-ellipsis">'+esc(it.updated_at||'')+'</div>'+
                '</div>'+
                '<div class="engine-card-body">'+
                  '<div class="kv"><div class="k">服务商</div><div class="v text-ellipsis">'+esc(it.provider)+'</div></div>'+
                  '<div class="kv"><div class="k">API地址</div><div class="v text-ellipsis">'+esc(it.api_url)+'</div></div>'+
                  '<div class="kv"><div class="k">模型</div><div class="v text-ellipsis">'+esc(it.model_name)+'</div></div>'+
                  '<div class="kv"><div class="k">描述</div><div class="v text-ellipsis">'+esc(it.description||'')+'</div></div>'+
                  '<div class="ops">'+
                    '<button class="layui-btn layui-btn-warm layui-btn-xs" data-action="edit" data-id="'+it.id+'">编辑</button>'+
                    '<button class="layui-btn layui-btn-danger layui-btn-xs" data-action="del" data-id="'+it.id+'">删除</button>'+
                  '</div>'+
                '</div>'+
              '</div>';
    });
    $('#grid').html(html);
  }
  function renderPager(){
    laypage.render({
      elem: 'pager', count: total, limit: limit, curr: page,
      layout: ['prev','page','next','count'],
      jump: function(obj, first){ page = obj.curr; limit = obj.limit; if(!first){ fetch(); } }
    });
  }
  function fetch(){
    $.get("{{ url_for('admin.api_ai_engines_items') }}", {page: page, limit: limit, q: q}).done(function(res){
      cache = res.items || []; total = res.total || 0; render(); renderPager();
    }).fail(function(){ layer.msg('加载失败',{icon:2}); });
  }
  function openEdit(engine){
    var it = engine || {};
    function fillAndOpen(){
      var formHtml = '<div style="padding:12px">'+
        '<div class="layui-form-item"><label class="layui-form-label">服务商</label><div class="layui-input-block"><input id="edit-provider" class="layui-input" value="'+(esc(it.provider||''))+'"></div></div>'+
        '<div class="layui-form-item"><label class="layui-form-label">API地址</label><div class="layui-input-block"><input id="edit-api-url" class="layui-input" value="'+(esc(it.api_url||''))+'"></div></div>'+
        '<div class="layui-form-item"><label class="layui-form-label">API密钥</label><div class="layui-input-block"><input id="edit-api-key" class="layui-input" value="'+(esc(it.api_key||''))+'"></div></div>'+
        '<div class="layui-form-item"><label class="layui-form-label">模型名称</label><div class="layui-input-block"><input id="edit-model" class="layui-input" value="'+(esc(it.model_name||''))+'"></div></div>'+
        '<div class="layui-form-item"><label class="layui-form-label">描述</label><div class="layui-input-block"><textarea id="edit-desc" class="layui-textarea">'+(esc(it.description||''))+'</textarea></div></div>'+
      '</div>';
      layer.open({
        title: engine ? '编辑引擎' : '新增引擎', area: ['720px','560px'], content: formHtml, btn: ['保存','取消'],
        yes: function(index){
          var payload = {
            provider: $('#edit-provider').val().trim(),
            api_url: $('#edit-api-url').val().trim(),
            api_key: $('#edit-api-key').val().trim(),
            model_name: $('#edit-model').val().trim(),
            description: $('#edit-desc').val()
          };
          if(!payload.provider || !payload.api_url || !payload.model_name){ layer.msg('请填写必填项',{icon:0}); return; }
          var url = engine ? "{{ url_for('admin.api_ai_engines_update', engine_id=0) }}".replace('0', engine.id) : "{{ url_for('admin.api_ai_engines_create') }}";
          $.ajax({ url: url, method: 'POST', contentType: 'application/json', data: JSON.stringify(payload) })
            .done(function(){ layer.msg('已保存',{icon:1}); layer.close(index); fetch(); })
            .fail(function(){ layer.msg('保存失败',{icon:2}); });
        }
      });
    }
    if(engine){
      $.get("{{ url_for('admin.api_ai_engines_get', engine_id=0) }}".replace('0', engine.id)).done(function(res){ it = res || it; fillAndOpen(); }).fail(function(){ fillAndOpen(); });
    } else {
      fillAndOpen();
    }
  }
  $('#btn-add').on('click', function(){ openEdit(null); });
  $('#btn-search').on('click', function(){ q = $('#q').val().trim(); page = 1; fetch(); });
  $('#btn-refresh').on('click', function(){ fetch(); });
  $('#grid').on('click','button[data-action=edit]', function(){ var id = $(this).attr('data-id'); var it = cache.find(function(x){ return String(x.id)===String(id); }); openEdit(it||null); });
  $('#grid').on('click','button[data-action=del]', function(){ var id = $(this).attr('data-id'); layer.confirm('确认删除该引擎？', function(idx){ $.post("{{ url_for('admin.api_ai_engines_delete', engine_id=0) }}".replace('0', id), {}).done(function(){ layer.msg('已删除',{icon:1}); fetch(); }).fail(function(){ layer.msg('删除失败',{icon:2}); }); layer.close(idx); }); });
  fetch();
});
</script>
{% endblock %}
