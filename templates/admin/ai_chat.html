{% extends 'base.html' %}
{% block content %}
<div class="layui-card">
  <div class="layui-card-header" style="display:flex;justify-content:space-between;align-items:center">
    <div>AI助手对话</div>
    <a class="layui-btn layui-btn-danger layui-btn-sm" href="{{ url_for('admin.ai_assistants') }}">退出</a>
  </div>
  <div class="layui-card-body">
    <div id="chat" class="chat-box"></div>
    <div class="chat-input">
      <input type="text" id="msg" placeholder="输入消息" autocomplete="off" class="layui-input">
      <button class="layui-btn" id="btn-send">发送</button>
    </div>
  </div>
</div>
{% endblock %}
{% block page_script %}
<style>
.chat-box{height:520px;border:1px solid #eee;border-radius:8px;padding:12px;overflow:auto;background:#fafafa}
.msg{margin-bottom:12px;display:flex;gap:10px}
.msg .avatar{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;color:#fff;flex:0 0 32px}
.msg.user{flex-direction:row-reverse}
.msg.user .avatar{background:#1E9FFF}
.msg.assistant .avatar{background:#16b777}
.msg .wrap{max-width:72%}
.msg .meta{font-size:12px;color:#999;margin-bottom:4px}
.msg .bubble{display:inline-block;width:auto;padding:10px;border-radius:10px;line-height:1.6;white-space:pre-wrap}
.msg.user .bubble{background:#e6f7ff;color:#333}
.msg.assistant .bubble{background:#f0f9eb;color:#333}
.chat-input{display:flex;gap:8px;margin-top:12px}
.typing .bubble{position:relative}
.dots{display:inline-flex;gap:6px;align-items:center}
.dots span{width:6px;height:6px;border-radius:50%;background:#999;opacity:.4;animation:blink 1s infinite}
.dots span:nth-child(2){animation-delay:.2s}
.dots span:nth-child(3){animation-delay:.4s}
@keyframes blink{0%{opacity:.2}50%{opacity:1}100%{opacity:.2}}
</style>
<script>
layui.use(['jquery','layer'], function(){
  var $ = layui.jquery; var layer = layui.layer;
  var assistantId = {{ assistant_id }};
  var busy = false;
  function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function addMsg(role, content){
    var name = role==='user' ? '我' : '助手';
    var avatar = role==='user' ? '我' : 'AI';
    var html = '<div class="msg '+role+'">'+
                 '<div class="avatar">'+avatar+'</div>'+
                 '<div class="wrap">'+
                   '<div class="meta">'+name+'</div>'+
                   '<div class="bubble">'+esc(content)+'</div>'+
                 '</div>'+
               '</div>';
    $('#chat').append(html);
    $('#chat').scrollTop($('#chat')[0].scrollHeight);
  }
  function addThinking(){
    var html = '<div class="msg assistant typing" id="typing">'+
                 '<div class="avatar">AI</div>'+
                 '<div class="wrap">'+
                   '<div class="meta">助手</div>'+
                   '<div class="bubble"><span class="dots"><span></span><span></span><span></span></span></div>'+
                 '</div>'+
               '</div>';
    $('#chat').append(html);
    $('#chat').scrollTop($('#chat')[0].scrollHeight);
  }
  $('#msg').focus();
  $('#msg').on('keydown', function(e){
    if(e.key === 'Enter'){
      if(e.shiftKey){ return; }
      e.preventDefault();
      $('#btn-send').click();
    }
  });
  $('#btn-send').on('click', function(){
    if(busy){ return; }
    var txt = $('#msg').val().trim(); if(!txt){ return; }
    addMsg('user', txt);
    $('#msg').val('');
    addThinking();
    busy = true; $('#btn-send').attr('disabled', true).addClass('layui-btn-disabled');
    $.ajax({
      url: "{{ url_for('admin.api_ai_assistants_chat', assistant_id=0) }}".replace('0', assistantId),
      method: 'POST', contentType: 'application/json', data: JSON.stringify({text: txt}),
      success: function(res){
        $('#typing').remove();
        var reply = (res.reply||'').trim();
        if(!reply){ reply = '（无回复）'; }
        addMsg('assistant', reply);
        busy = false; $('#btn-send').attr('disabled', false).removeClass('layui-btn-disabled'); $('#msg').focus();
      },
      error: function(){
        $('#typing').remove();
        busy = false; $('#btn-send').attr('disabled', false).removeClass('layui-btn-disabled'); $('#msg').focus();
        layer.msg('发送失败',{icon:2});
      }
    });
  });
});
</script>
{% endblock %}
